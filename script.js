const precios = {
        "2k": {
          "T.S. ESPECIAL": 15500,
          "Z.P. ZARCO PLAS": 15800,
          "T.V. TE VERDE": 17000,
        },
        "3k": {
          "Blanca Eco.Alta": 17000,
          "T.S. ESPECIAL": 17500,
          "Z.P. ZARCO PLAS": 19500,
          "T.V. TE VERDE": 23000,
        },
        "5k": {
          "T.S. ESPECIAL": 28000,
          "Z.P. ZARCO PLAS": 29000,
          "T.V. TE VERDE": 35000,
        },
        "10k": {
          "T.S. ESPECIAL": 35000,
          "Z.P. ZARCO PLAS": 39000,
          "T.V. TE VERDE": 45000,
        },
        "15k": { "T.S. ESPECIAL": 47000, "Z.P. ZARCO PLAS": 52000 },
        "25k": { "T.S. ESPECIAL": 6800 },
        "5x8": { "Color.": 19000, "Blanca Alta.": 18000 },
        "6x9": {
          "Color.": 24000,
          "Blanca Alta.": 23000,
          "T.V. TE VERDE": 65000,
          Bogotano: 65000,
        },
        "7x10": {
          "Color.": 29000,
          "Blanca Alta.": 27000,
          "T.V. TE VERDE": 65000,
          Bogotano: 65000,
        },
        "8x12": {
          "Color.": 37000,
          "Blanca Alta.": 34000,
          "T.V. TE VERDE": 65000,
          Bogotano: 65000,
        },
        "10x14": { "Color.": 63000 },
        basura: { PEQUEÑA: 10000, JUMBO: 14000, "N.N.": 20000 },
        hielo: {
          "JUMBO X50": 45000,
          "JUMBO X25": 23000,
          "NORMAL X50": 33000,
          "NORMAL X25": 17000,
          "CORTO X50": 22000,
          "CORTO X25": 11500,
          "CORTO NATURAL X50": 25000,
          "CORTO NATURAL X25": 13000,
        },
        boli: {
          "BOLI CORTO X50": 12000,
          "BOLI CORTO X25": 6500,
          "BOLI LARGO X50": 17000,
          "BOLI LARGO X25": 9000,
          ACEITERA: 16000,
        },
        "Cuero de vaca": { "Cuero de vaca": 12000 },
        Vasos: {
          "vaso 7 oz x25": 1100,
          "vasos 3.3 x50": 1600,
          "vasos 2.5x50": 1400,
          "vasos roneros x50": 1200,
          "vasos 5.5x50": 2000,
        },
        Pitillos: {
          "Pitillos x100": 900,
        },
        Cucharas: {
          "Cucharas x100": 4000,
          "cuchara dulcera": 2500,
        },
        Trinches: {
          "Trinches x100": 4000,
        },
        Cuchillos: {
          "Cuchillos x100": 4000,
        },
        "Porta comida": {
          "J1 UND": 400,
          "J2 UND": 400,
          "paca J1": 72000,
          "paca J2": 72000,
        },
        "Porta hamburguesas": {
          "porta hamburgesas UND": 300,
        },
        Contenedor: {
          "#16": 7300,
          "#24": 9200,
          "#32": 16650,
        },
        "Vasos soperos": {
          "vasos soperos UND": 6500,
        },
        Platos: {
          "#15": 2300,
          "#18": 3000,
          "#20": 3750,
          "#23": 4400,
          "#26": 5900,
        },
      };

      const preciosund = {
        "2k": {
          "T.S. ESPECIAL": 1550,
          "Z.P. ZARCO PLAS": 1580,
          "T.V. TE VERDE": 1700,
        },
        "3k": {
          "Blanca Eco.Alta": 1700,
          "T.S. ESPECIAL": 1750,
          "Z.P. ZARCO PLAS": 1950,
          "T.V. TE VERDE": 2300,
        },
        "5k": {
          "T.S. ESPECIAL": 2800,
          "Z.P. ZARCO PLAS": 2900,
          "T.V. TE VERDE": 3500,
        },
        "10k": {
          "T.S. ESPECIAL": 3500,
          "Z.P. ZARCO PLAS": 3900,
          "T.V. TE VERDE": 4500,
        },
        "15k": { "T.S. ESPECIAL": 4700, "Z.P. ZARCO PLAS": 5200 },
        "25k": { "T.S. ESPECIAL": 6800 },
        "5x8": { "Color.": 380, "Blanca Alta.": 360 },
        "6x9": {
          "Color.": 480,
          "Blanca Alta.": 460,
        },
        "7x10": {
          "Color.": 580,
          "Blanca Alta.": 540,
        },
        "8x12": {
          "Color.": 740,
          "Blanca Alta.": 680,
        },
        "10x14": { "Color.": 1260 },
        basura: { PEQUEÑA: 10000, JUMBO: 14000, "N.N.": 20000 },
        hielo: {
          "JUMBO X50": 900,
          "NORMAL X50": 660,
          "CORTO X50": 450,
          "CORTO NATURAL X50": 500,
        },
        boli: {
          "BOLI CORTO X50": 250,
          "BOLI LARGO X50": 350,
        },
        "Cuero de vaca": { "Cuero de vaca": 12000 },
        Vasos: {
          "vaso 7 oz x25": 1100,
          "vasos 3.3 x50": 1600,
          "vasos 2.5x50": 1400,
          "vasos roneros x50": 1200,
          "vasos 5.5x50": 2000,
        },
        Pitillos: {
          "Pitillos x100": 900,
        },
        Cucharas: {
          "Cucharas x100": 4000,
          "cuchara dulcera": 2500,
        },
        Trinches: {
          "Trinches x100": 4000,
        },
        Cuchillos: {
          "Cuchillos x100": 4000,
        },
        "Porta comida": {
          "J1 UND": 400,
          "J2 UND": 400,
          "paca J1": 72000,
          "paca J2": 72000,
        },
        "Porta hamburguesas": {
          "porta hamburgesas UND": 300,
        },
        Contenedor: {
          "#16": 7300,
          "#24": 9200,
          "#32": 16650,
        },
        "Vasos soperos": {
          "vasos soperos UND": 6500,
        },
        Platos: {
          "#15": 2300,
          "#18": 3000,
          "#20": 3750,
          "#23": 4400,
          "#26": 5900,
        },
      };

      const productos = [];
      function actualizarSubtipos() {
        const tipo = document.getElementById("tipoBolsa").value;
        const subtipo = document.getElementById("subtipoBolsa");
        subtipo.innerHTML = "";
        if (!tipo || !precios[tipo]) return;
        Object.keys(precios[tipo]).forEach((op) => {
          const option = document.createElement("option");
          option.value = op;
          option.textContent = op;
          subtipo.appendChild(option);
        });

        actualizarPrecio();
      }

      function actualizarPrecio() {
        const tipo = document.getElementById("tipoBolsa").value;
        const subtipo = document.getElementById("subtipoBolsa").value;
        const modo = document.getElementById("comprarPor").value;
        let precio = 0;

        if (modo === "millar") {
          precio = precios[tipo]?.[subtipo] || 0;
        } else if (modo === "unidad") {
          precio = preciosund[tipo]?.[subtipo] || 0;
        }
        document.getElementById("precioUnitario").textContent = precio;
      }

      function agregarProducto() {
        const tipo = document.getElementById("tipoBolsa").value;
        const subtipo = document.getElementById("subtipoBolsa").value;
        const cantidad = parseInt(document.getElementById("cantidad").value);
        const modo = document.getElementById("comprarPor").value;
        let precio = 0;

        if (modo === "millar") {
          precio = precios[tipo]?.[subtipo] || 0;
        } else if (modo === "unidad") {
          precio = preciosund[tipo]?.[subtipo] || 0;
        }

        if (!tipo || !subtipo || !cantidad || cantidad < 1) {
          alert("Completa todos los campos para agregar un producto.");
          return;
        }

        productos.push({ tipo, subtipo, cantidad, precio });
        mostrarTabla();
      }

      function mostrarTabla() {
        const tbody = document.querySelector("#tablaProductos tbody");
        tbody.innerHTML = "";
        let total = 0;

        productos.forEach((prod, index) => {
          const fila = document.createElement("tr");
          const subtotal = prod.precio * prod.cantidad;
          total += subtotal;

          fila.innerHTML = `
          <td>${prod.tipo}</td>
          <td>${prod.subtipo}</td>
          <td>${prod.cantidad}</td>
          <td>$${prod.precio.toLocaleString()}</td>
          <td>$${subtotal.toLocaleString()}</td>
          <td><button onclick="eliminarProducto(${index})">X</button></td>
        `;
          tbody.appendChild(fila);
        });

        document.getElementById("tablaProductos").style.display = "table";
        document.getElementById(
          "totalGeneral"
        ).innerText = `Total general: $${total.toLocaleString()}`;
      }

      function eliminarProducto(i) {
        productos.splice(i, 1);
        mostrarTabla();
      }

      function exportarExcel() {
        const historial = JSON.parse(localStorage.getItem("facturas")) || [];
        let csv = "ID,Cliente,Fecha,Total,Estado\n";
        historial.forEach((f) => {
          csv += `${f.id},"${f.cliente}","${f.fecha}",${f.total},${f.estado}\n`;
        });
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "historial_facturas.csv";
        link.click();
      }

      function generarRecibo() {
        const cliente = document.getElementById("cliente").value.trim();
        if (!cliente || productos.length === 0) {
          alert("Debes ingresar el nombre del cliente y al menos un producto.");
          return;
        }

        const fecha = new Date().toLocaleString();
        let total = 0;
        const detalles = productos.map((p) => {
          const subtotal = p.precio * p.cantidad;
          total += subtotal;
          return { ...p, subtotal };
        });

        const id = Date.now();
        const factura = {
          id,
          cliente,
          fecha,
          detalles,
          total,
          estado: "Pendiente",
        };
        guardarFactura(factura);
        mostrarReciboHTML(factura);
        productos.length = 0;
        mostrarTabla();
        cargarHistorial();
      }

      function mostrarReciboHTML(factura) {
        let html = `<h3>Recibo</h3>
        <p><strong>Cliente:</strong> ${factura.cliente}</p>
        <p><strong>Fecha:</strong> ${factura.fecha}</p>
        <table>
          <tr>
            <th>Cantidad</th>
            <th>Tipo</th>
            <th>Subtipo</th>
            <th>Precio</th>
            <th>Total</th>
          </tr>`;

        factura.detalles.forEach((p) => {
          html += `<tr>
            <td>${p.cantidad}</td>
            <td>${p.tipo}</td>
            <td>${p.subtipo}</td>
            <td>$${p.precio.toLocaleString()}</td>
            <td>$${p.subtotal.toLocaleString()}</td>
          </tr>`;
        });

        html += `</table>
        <h4>Total a pagar: $${factura.total.toLocaleString()}</h4>
        <p><strong>Estado:</strong> ${factura.estado}</p>`;

        document.getElementById("recibo").innerHTML = html;
      }

      function guardarFactura(factura) {
        const historial = JSON.parse(localStorage.getItem("facturas")) || [];
        historial.push(factura);
        localStorage.setItem("facturas", JSON.stringify(historial));
      }

      function cargarHistorial() {
        const tbody = document.querySelector("#tablaHistorial tbody");
        tbody.innerHTML = "";
        const historial = JSON.parse(localStorage.getItem("facturas")) || [];

        historial.forEach((factura) => {
          const fila = document.createElement("tr");
          fila.className = factura.estado === "Pagado" ? "pagado" : "pendiente";
          fila.innerHTML = `
          <td>${factura.id}</td>
          <td>${factura.cliente}</td>
          <td>${factura.fecha}</td>
          <td>$${factura.total.toLocaleString()}</td>
          <td>${factura.estado}</td>
          <td>
            <button onclick="verFactura(${factura.id})">Ver</button>
            <button onclick="cambiarEstado(${
              factura.id
            })">Cambiar Estado</button>
            <button onclick="eliminarFactura(${factura.id})">Eliminar</button>
            <button onclick="editarFactura(${factura.id})">Editar</button>
          </td>
        `;
          tbody.appendChild(fila);
        });
      }

      // Ver factura: mostrar recibo en pantalla
      function verFactura(id) {
        const historial = JSON.parse(localStorage.getItem("facturas")) || [];
        const factura = historial.find((f) => f.id === id);
        if (factura) mostrarReciboHTML(factura);
      }

      // Editar factura: cargar datos en el formulario para editar
      function editarFactura(id) {
        const historial = JSON.parse(localStorage.getItem("facturas")) || [];
        const factura = historial.find((f) => f.id === id);
        if (factura) {
          document.getElementById("cliente").value = factura.cliente;
          productos.length = 0; // Limpiar productos
          factura.detalles.forEach((p) => productos.push(p));
          mostrarTabla();
          document.getElementById("recibo").innerHTML = ""; // Limpiar recibo
        }
      }

      // Cambiar estado de la factura entre "Pagado" y "Pendiente"

      function cambiarEstado(id) {
        const historial = JSON.parse(localStorage.getItem("facturas")) || [];
        const index = historial.findIndex((f) => f.id === id);
        if (index !== -1) {
          historial[index].estado =
            historial[index].estado === "Pagado" ? "Pendiente" : "Pagado";
          localStorage.setItem("facturas", JSON.stringify(historial));
          cargarHistorial();
        }
      }

      // Eliminar factura del historial
      function eliminarFactura(id) {
        const historial = JSON.parse(localStorage.getItem("facturas")) || [];
        const actualizado = historial.filter((f) => f.id !== id);
        localStorage.setItem("facturas", JSON.stringify(actualizado));
        cargarHistorial();
      }

      window.onload = cargarHistorial;
      function imprimirRecibo() {
        const contenido = document.getElementById("recibo").innerHTML;
        const ventana = window.open("", "", "width=800,height=600");

        ventana.document.write(`
        <html>
          <head>
            <title>Recibo</title>
            <style>
              body {
                font-family: Arial, sans-serif;
                padding: 20px;
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
              }
              th, td {
                padding: 8px;
                border: 1px solid #ccc;
                text-align: left;
              }
              h3, h4, p {
                margin: 10px 0;
              }
            </style>
          </head>
          <body onload="window.print(); setTimeout(() => window.close(), 500);">
            ${contenido}
          </body>
        </html>
      `);

        ventana.document.close(); // Importante para que se dispare onload
      }